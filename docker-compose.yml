version: '3'
networks:
  reu.net:
    driver: bridge
services:
  #####################################################
  # API SERVICES
  #####################################################

  #######################################
  ###  Order Service : prise de commandes, suivi des commandes
  ###  api api.order
  ###  database gérée par le service mysql.order (sql)
  ###  requêtes HTTP vers api.catalog et api.fidelisation
  #######################################

  # service api.order : api pour la prise de commandes et le suivi de commandes
  #
  api.reunionou:
    image: 'canals/php:latest'
    environment:
      - VHOST_HOSTNAME=api.reunionou.local
      - VHOST_DOCROOT=/var/www/
    ports:
      - '19080:80'
      - '19043:443'
    volumes:
      - './reu_reunionou_service:/var/www'
    working_dir: /var/www/
    networks:
      - reu.net
    depends_on:
      - reunionou.db

  # service sql pour le stockage des commandes -
  # utilisé par l'api order

  reunionou.db:
    image: 'mariadb:latest'
    command: '--default-authentication-plugin=mysql_native_password --character-set-server=utf8 --collation-server=utf8_general_ci'
    environment:
      - MYSQL_ROOT_PASSWORD=reunionou
      - MYSQL_USER=reunionou_lbs
      - MYSQL_PASSWORD=reunionou_lbs
      - MYSQL_DATABASE=reunionou_lbs
    ports:
      - '3307:3306'
    networks:
      - reu.net
    volumes:
      - './reu_reunionou_service/sql:/var/sql'

  #
  # service administration des bases sql
  #

  adminer:
    image: adminer
    ports:
      - '8080:8080'
    networks:
      - reu.net

  ######################################
  ###  AUTH Service : service d'authentification JWT
  ###  api api.auth : auth, check, refresh de token JWT
  ###  utilise sa propre base de données
  ######################################
  api.auth:
      image: 'canals/php:latest'
      environment:
        - VHOST_HOSTNAME=api.auth.local
        - VHOST_DOCROOT=/var/www/public/
      ports:
        - '19780:80'
        - '19743:443'
      volumes:
        - './reu_auth_service/public:/var/www/public'
        - './reu_auth_service/config:/var/www/config'
        - './reu_auth_service/src:/var/www/src'
        - './reu_auth_service/vendor:/var/www/vendor'
      working_dir: /var/www/
      networks:
        - reu.net
      depends_on:
        - mongo.auth

  mongo.auth:
        image: 'mongo:latest'
        environment:
          - MONGO_INITDB_ROOT_PASSWORD=authR00t
          - MONGO_INITDB_ROOT_USERNAME=auth_reu
          - MONGO_INITDB_DATABASE=auth_reu
        ports:
          - '27017:27017'
        networks:
          - reu.net
        volumes:
          - './reu_auth_service/mongoData:/var/data'
        working_dir: /var/data
        restart: always

#  mongo-express:
#        image: mongo-express
#        restart: always
#        ports:
#          - 8081:8081
#        networks:
#          - reu.net
#        environment:
#          ME_CONFIG_MONGODB_ADMINUSERNAME: root
#          ME_CONFIG_MONGODB_ADMINPASSWORD: root
#          ME_CONFIG_MONGODB_URL: mongodb://auth_reu:authR00t@mongo.auth:27017/


  ###########################################################
  #
  #   Service catalogue, réalisé avec le CMS Headless Directus
  #   Service SQL géré par postgres
  #
  ###########################################################

#  catalogue.data:
#    image: postgis/postgis:13-master
#    volumes:
#      - ./lbs_catalogue_service/data/database:/var/lib/postgresql/data
#    networks:
#      - lbs23.net
#    environment:
#      POSTGRES_USER: 'catalogue'
#      POSTGRES_PASSWORD: 'catalogue'
#      POSTGRES_DB: 'catalogue'
#
#  api.catalogue:
#    image: directus/directus:latest
#    ports:
#      - 19055:8055
#    volumes:
#      - ./lbs_catalogue_service/uploads:/directus/uploads
#      - ./lbs_catalogue_service/extensions:/directus/extensions
#    networks:
#      - lbs23.net
#    depends_on:
#      - catalogue.data
#    environment:
#      KEY: '255d861b-5ea1-5996-9aa3-922530ec40b1'
#      SECRET: '6116487b-cda1-52c2-b5b5-c8022c45e263'
#
#      DB_CLIENT: 'pg'
#      DB_HOST: 'catalogue.data'
#      DB_PORT: '5432'
#      DB_DATABASE: 'catalogue'
#      DB_USER: 'catalogue'
#      DB_PASSWORD: 'catalogue'
#
#      CACHE_ENABLED: 'false'
#      ADMIN_EMAIL: 'admin@example.com'
#      ADMIN_PASSWORD: 'd1r3ctu5'
#
#



#######################################
###  backoffice : web wrapper html pour la gestion du catalogue
###  connexion avec l'api catalogue
#######################################
#  web.catalogue:
#    image: 'canals/php:latest'
#    environment:
#      - VHOST_HOSTNAME=web.catalogue.local
#      - VHOST_DOCROOT=/var/www/public
#    ports:
#      - '19480:80'
#      - '19443:443'
#    volumes:
#      - './lbs_catalogue_web/public:/var/www/public'
#      - './lbs_catalogue_web/src:/var/www/src'
#    working_dir: /var/www/src
#    networks:
#      - lbs.net
#    depends_on:
#      - api.catalogue
#
